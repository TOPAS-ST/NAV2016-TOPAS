OBJECT Page 50027 Service Anfgemodus
{
  OBJECT-PROPERTIES
  {
    Date=14.11.17;
    Time=09:18:33;
    Modified=Yes;
    Version List=TOPAS;
  }
  PROPERTIES
  {
    SaveValues=Yes;
    InsertAllowed=No;
    SourceTable=Table50024;
    DelayedInsert=Yes;
    SourceTableView=WHERE(Art=FILTER(Tempor„r));
    PageType=List;
    OnAfterGetRecord=BEGIN
                       AktualisiereWartungsvertragsnr;
                     END;

    OnQueryClosePage=BEGIN
                       IF (Rec.GETFILTERS <> '') AND (Rec.Art = Rec.Art::Tempor„r) THEN BEGIN
                         TempLizenzTab.RESET;
                         TempLizenzTab.SETRANGE(Art,TempLizenzTab.Art::Tempor„r);
                         TempLizenzTab.SETRANGE("Auftragsnr.","Auftragsnr.");
                         TempLizenzTab.SETRANGE("Auftragszeilennr.","Auftragszeilennr.");
                         TempLizenzTab.SETRANGE(Fremderwerb,TRUE);
                         IF TempLizenzTab.FINDFIRST THEN
                           REPEAT
                             Artikel.GET(TempLizenzTab."Artikelnr.");
                             IF Artikel."Item Tracking Code" <> 'KEINE' THEN BEGIN
                               IF ((TempLizenzTab."Artikelnr." = '') OR (TempLizenzTab."Seriennr." = '') AND ((Artikel."Item Tracking Code" = 'SERIENNR') OR (Artikel."Item Tracking Code" = 'SERIENNR+P')))
                               OR (((Artikel."Item Tracking Code" = 'PRODUCTKEY') OR (Artikel."Item Tracking Code" = 'SERIENNR+P')) AND (TempLizenzTab."Product Key" = '')) THEN
                                 IF CONFIRM(Text001,FALSE,FALSE) THEN
                                   TempLizenzTab.DELETEALL
                                 ELSE
                                   ERROR('');
                             END;
                           UNTIL TempLizenzTab.NEXT = 0;
                       END;
                     END;

    ActionList=ACTIONS
    {
      { 1900000000;  ;ActionContainer;
                      ActionContainerType=ActionItems }
      { 1       ;1   ;ActionGroup;
                      CaptionML=[DEU=Funktionen;
                                 ENU=General] }
      { 1140022 ;2   ;Action    ;
                      Name=AlleVormerken;
                      CaptionML=DEU=Alle Vormerken;
                      Promoted=Yes;
                      PromotedIsBig=Yes;
                      Image=SelectEntries;
                      PromotedCategory=Process;
                      OnAction=BEGIN
                                 CurrPage.SAVERECORD;
                                 IF AlleTempSeriennrVormerken(Rec) = TRUE THEN
                                   BEGIN
                                     CurrPage.UPDATE(TRUE);
                                   END;
                               END;
                                }
    }
  }
  CONTROLS
  {
    { 1900000;0;Container ;
                ContainerType=ContentArea }

    { 1900001;1;Group     ;
                GroupType=Repeater }

    { 1140001;2;Field     ;
                SourceExpr="Nr.";
                Editable=FALSE }

    { 1140003;2;Field     ;
                SourceExpr="Artikelnr." }

    { 1140005;2;Field     ;
                SourceExpr="Seriennr.";
                OnValidate=BEGIN
                             IF Fremderwerb = FALSE THEN BEGIN
                               IF Reklamiert AND Ersatzverfahren THEN BEGIN
                                 TempLizenzTab.RESET;
                                 TempLizenzTab.SETFILTER("Lfd. Nr.",'%1',"Ersatz fr Lfd. Nr.");
                                 IF (TempLizenzTab.FINDFIRST) AND ("Seriennr." = TempLizenzTab."Seriennr.") THEN BEGIN END
                                   ELSE
                                     ERROR(Text000,FIELDCAPTION("Seriennr."));
                               END ELSE
                                 ERROR(Text000,FIELDCAPTION("Seriennr."));
                             END;

                             IF (Fremderwerb = TRUE) AND (Verl„ngerung = TRUE) THEN
                               ERROR(Text000,FIELDCAPTION("Seriennr."));
                           END;
                            }

    { 1000000000;2;Field  ;
                SourceExpr="Product Key" }

    { 1140007;2;Field     ;
                DecimalPlaces=0:0;
                SourceExpr=Menge;
                Editable=FALSE }

    { 1140012;2;Field     ;
                SourceExpr=Vormerkung;
                OnValidate=VAR
                             TempRec@1140001 : Record 50024;
                           BEGIN
                             //Unzugeordnete Systempositionen werden dem Basissystem automatisch zugeordnet
                             IF (Vormerkung = TRUE) AND (Art = Art::Tempor„r) THEN BEGIN
                               PrfeSystemTab.RESET;
                               PrfeSystemTab.SETRANGE(Art,PrfeSystemTab.Art::System);
                               PrfeSystemTab.SETRANGE("Artikelnr.","Artikelnr.");
                               PrfeSystemTab.SETRANGE("Seriennr.","Seriennr.");
                               PrfeSystemTab.SETRANGE("Nr.","Nr.");
                               PrfeSystemTab.SETRANGE("Belegzeilennr.","Belegzeilennr.");
                               PrfeSystemTab.SETRANGE(Inaktiv,FALSE);
                               PrfeSystemTab.SETRANGE("Wartungsvertragsnr.",'');
                               IF PrfeSystemTab.FINDLAST THEN BEGIN
                                 ServiceZuordnung.RESET;
                                 ServiceZuordnung.SETRANGE("Nr.","Auftragsnr.");
                                 ServiceZuordnung.SETRANGE("Zeilennr.","Auftragszeilennr.");
                                 ServiceZuordnung.SETRANGE("Belegnr.","Nr.");
                                 ServiceZuordnung.SETRANGE("Belegzeilennr.","Belegzeilennr.");
                                 ServiceZuordnung.SETRANGE("Ger„te Artikelnr.","Artikelnr.");
                                 IF (ServiceZuordnung.FINDFIRST) AND (ServiceZuordnung."Wartungsvertragsnr." <> '') THEN BEGIN
                                   PrfeSystemTab."Zum Verschieben markieren" := TRUE;
                                   PrfeSystemTab.MODIFY(TRUE);
                                   IF PrfeSystemTab.SystemPos_verschieben('',ServiceZuordnung."Wartungsvertragsnr.") = FALSE THEN
                                     Vormerkung := FALSE;
                                 END ELSE BEGIN
                                   ServiceZuordnung.RESET;
                                   ServiceZuordnung.SETRANGE("Nr.","Auftragsnr.");
                                   ServiceZuordnung.SETRANGE("Zeilennr.","Auftragszeilennr.");
                                   ServiceZuordnung.SETRANGE(Basisger„t,TRUE);
                                   IF ServiceZuordnung.FINDFIRST THEN BEGIN
                                     TempRec.RESET;
                                     TempRec.SETRANGE(Art,TempRec.Art::Tempor„r);
                                     TempRec.SETRANGE("Artikelnr.",ServiceZuordnung."Ger„te Artikelnr.");
                                     TempRec.SETRANGE("Auftragsnr.",ServiceZuordnung."Nr.");
                                     TempRec.SETRANGE("Auftragszeilennr.",ServiceZuordnung."Zeilennr.");
                                     IF TempRec.FINDFIRST THEN BEGIN
                                       PrfeNeuenWV.RESET;
                                       PrfeNeuenWV.SETRANGE(Art,PrfeSystemTab.Art::System);
                                       PrfeNeuenWV.SETRANGE("Artikelnr.",TempRec."Artikelnr.");
                                       PrfeNeuenWV.SETRANGE("Seriennr.",TempRec."Seriennr.");
                                       PrfeNeuenWV.SETRANGE("Nr.",ServiceZuordnung."Belegnr.");
                                       PrfeNeuenWV.SETRANGE("Belegzeilennr.",ServiceZuordnung."Belegzeilennr.");
                                       PrfeNeuenWV.SETRANGE(Inaktiv,FALSE);
                                       IF PrfeNeuenWV.FINDLAST THEN BEGIN
                                         PrfeSystemTab."Zum Verschieben markieren" := TRUE;
                                         PrfeSystemTab.MODIFY(TRUE);
                                         IF PrfeSystemTab.SystemPos_verschieben('',PrfeNeuenWV."Wartungsvertragsnr.") = FALSE THEN
                                           Vormerkung := FALSE;
                                       END;
                                     END;
                                   END;
                                 END;
                               END;
                             END;

                             AktualisiereWartungsvertragsnr;
                             CheckCrossCalculationsValid;
                           END;
                            }

    { 1140020;2;Field     ;
                CaptionML=DEU=Wartungsvertragsnr.;
                SourceExpr=wartungsnr;
                Editable=FALSE;
                OnLookup=BEGIN
                           IF wartungsnr = '' THEN
                             EXIT;

                           Wartungsvertrag.SETFILTER("Wartungsvertragsnr.",wartungsnr);
                           PAGE.RUN(PAGE::"Wartungsvertrag Karte",Wartungsvertrag);
                         END;
                          }

    { 1140014;2;Field     ;
                CaptionML=DEU=Wartung vorhanden;
                ToolTipML=DEU=Gibt an, dass die Position mit dieser Seriennr. bereits in Wartung ist. Wenn dieser Datensatz gebucht wird, dient dieser als Verl„ngerung des bestehenden Satzes.;
                SourceExpr=Verl„ngerung;
                Editable=FALSE }

    { 1140016;2;Field     ;
                SourceExpr=Reklamiert;
                Editable=FALSE }

    { 1140018;2;Field     ;
                SourceExpr=Ersatzverfahren;
                Editable=FALSE }

  }
  CODE
  {
    VAR
      TempLizenzTab@1140002 : Record 50024;
      PrfeLizenzTab@1140006 : Record 50024;
      PrfeServiceTab@1140009 : Record 50024;
      PrfeSystemTab@1140010 : Record 50024;
      AktuelleServiceZuordnung@1000000001 : Record 50027;
      ServiceZuordnung@1140012 : Record 50027;
      PrfeNeuenWV@1140011 : Record 50024;
      Wartungsvertrag@1140008 : Record 50011;
      Artikel@1140001 : Record 27;
      Text000@1140003 : TextConst 'DEU=Sie k”nnen %1 nicht mehr „ndern.';
      Text001@1140004 : TextConst 'DEU=Sie haben noch nicht alle Felder ausgefllt. Wenn Sie mit Ja best„tigen, werden vorhandene Datens„tze gel”scht.\M”chten Sie das Fenster wirklich schlieáen?';
      wartungsnr@1140007 : Code[120];
      Text002@1000000002 : TextConst 'DEU=Es konnte im Beleg eine zu der %1 passende Re-Instatement-Fee Kalkulation gefunden werden. Soll der Vertrag ab einem bestimmten Datum loslaufen?\Dann setzen Sie bitte das H„kchen im Feld %2.';
      Text003@1000000000 : TextConst 'DEU=In diesem Beleg konnte eine weitere Kalkulation in Zeile %1 mit šbereinstimmung der %2 und Serviceleistung gefunden werden. Sie wrden damit eine Service Doppelbuchung fr %2 %3 ausl”sen.\M”chten Sie den Vorgang dennoch fortsetzen?';

    PROCEDURE AktualisiereWartungsvertragsnr@1140000();
    BEGIN
      wartungsnr := '';
      PrfeServiceTab.RESET;
      PrfeServiceTab.SETFILTER(Art,'%1|%2',PrfeServiceTab.Art::Service,PrfeServiceTab.Art::System);
      IF "Seriennr." = '' THEN BEGIN
        PrfeServiceTab.SETRANGE("Nr.","Nr.");
        PrfeServiceTab.SETRANGE("Belegzeilennr.","Belegzeilennr.");
      END;
      PrfeServiceTab.SETRANGE("Artikelnr.","Artikelnr.");
      PrfeServiceTab.SETRANGE("Seriennr.","Seriennr.");
      PrfeServiceTab.SETRANGE(Inaktiv,FALSE);
      IF PrfeServiceTab.FINDFIRST THEN
        REPEAT
          IF PrfeServiceTab."Wartungsvertragsnr." <> '' THEN BEGIN
            IF wartungsnr = '' THEN wartungsnr := PrfeServiceTab."Wartungsvertragsnr.";
            IF (STRPOS(wartungsnr,PrfeServiceTab."Wartungsvertragsnr.") = 0) AND
            (STRLEN(wartungsnr + '|' + PrfeServiceTab."Wartungsvertragsnr.") <= 120) THEN
              wartungsnr := wartungsnr + '|' + PrfeServiceTab."Wartungsvertragsnr.";
          END;
        UNTIL PrfeServiceTab.NEXT = 0
      ELSE
        wartungsnr := '';
    END;

    LOCAL PROCEDURE CheckCrossCalculationsValid@1000000000();
    VAR
      coexistent@1000000000 : Integer;
    BEGIN
      IF Vormerkung = FALSE THEN EXIT;

      coexistent := 0;
      AktuelleServiceZuordnung.RESET;
      AktuelleServiceZuordnung.SETRANGE("Nr.","Auftragsnr.");
      AktuelleServiceZuordnung.SETRANGE("Zeilennr.","Auftragszeilennr.");
      AktuelleServiceZuordnung.SETRANGE("Belegnr.","Nr.");
      AktuelleServiceZuordnung.SETRANGE("Belegzeilennr.","Belegzeilennr.");
      IF AktuelleServiceZuordnung.FINDFIRST THEN BEGIN
        TempLizenzTab.RESET;
        TempLizenzTab.SETRANGE(Art,TempLizenzTab.Art::Tempor„r);
        TempLizenzTab.SETRANGE("Auftragsnr.","Auftragsnr.");
        TempLizenzTab.SETFILTER("Auftragszeilennr.",'<>%1',"Auftragszeilennr.");
        TempLizenzTab.SETRANGE("Nr.","Nr.");
        TempLizenzTab.SETRANGE("Belegzeilennr.","Belegzeilennr.");
        TempLizenzTab.SETRANGE("Artikelnr.","Artikelnr.");
        TempLizenzTab.SETRANGE("Seriennr.","Seriennr.");
        IF TempLizenzTab.FINDFIRST THEN BEGIN
          REPEAT
            ServiceZuordnung.RESET;
            ServiceZuordnung.SETRANGE("Nr.",TempLizenzTab."Auftragsnr.");
            ServiceZuordnung.SETRANGE("Zeilennr.",TempLizenzTab."Auftragszeilennr.");
            ServiceZuordnung.SETRANGE("Belegnr.",TempLizenzTab."Nr.");
            ServiceZuordnung.SETRANGE("Belegzeilennr.",TempLizenzTab."Belegzeilennr.");
            ServiceZuordnung.SETRANGE("Ger„te Artikelnr.",TempLizenzTab."Artikelnr.");
            IF ServiceZuordnung.FINDFIRST THEN BEGIN
              IF (ServiceZuordnung."SUP Artikelnr." = AktuelleServiceZuordnung."SUP Artikelnr.") AND (Vormerkung = TRUE) THEN
                coexistent += 1;
              Artikel.GET(ServiceZuordnung."SUP Artikelnr.");
              IF (STRPOS(Artikel.Artikelgruppe,'FEE') <> 0) AND (AktuelleServiceZuordnung."Beachte Startdatum" = FALSE) AND (Vormerkung = TRUE) THEN
                MESSAGE(Text002,FIELDCAPTION("Seriennr."),ServiceZuordnung.FIELDCAPTION("Beachte Startdatum"));
            END;
            IF coexistent > 0 THEN BEGIN
              IF NOT CONFIRM(Text003,FALSE,TempLizenzTab."Auftragszeilennr.",FIELDCAPTION("Seriennr."),"Seriennr.") THEN
                ERROR('')
              ELSE
                EXIT;
            END;
          UNTIL TempLizenzTab.NEXT = 0;
        END;
      END;
    END;

    BEGIN
    END.
  }
}

