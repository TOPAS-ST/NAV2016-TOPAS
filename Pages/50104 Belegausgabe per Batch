OBJECT Page 50104 Belegausgabe per Batch
{
  OBJECT-PROPERTIES
  {
    Date=18.09.20;
    Time=10:38:18;
    Modified=Yes;
    Version List=TOPAS;
  }
  PROPERTIES
  {
    InsertAllowed=No;
    DeleteAllowed=No;
    ModifyAllowed=No;
    ShowFilter=No;
    OnInit=BEGIN
             AttachmentPath := 'F:\Daten NEU\Gemeinsame Ordner\Customer Service\EMailVersand\';
             LagerortcodeFilter := 'ZENT';
             DocuwareServiceEnable := TRUE;
             //Performance Tests - Umstellung auf lokalen Pfad tempor„r:
             //AttachmentPath := 'O:\EMailVersand\';

             IF TOPAS_API.NewFolder(AttachmentPath) = FALSE THEN
               ERROR('Abbruch, Pfad nicht verfgbar: %1',AttachmentPath);

             //Žnd_Best_PDF:=TRUE;
             //Žnd_Best_Druck:=TRUE;
             //Best_PDF:=TRUE;
             //Best_Druck:=TRUE;
             IF DATE2DWY(WORKDATE, 1) = 1 THEN BEGIN
               // letzter Arbeitstag war Freitag
               Tagesdatum := WORKDATE - 3;
             END ELSE BEGIN
               Tagesdatum := WORKDATE - 1;
             END;
           END;

    ActionList=ACTIONS
    {
      { 1900000000;  ;ActionContainer;
                      ActionContainerType=ActionItems }
      { 1       ;1   ;ActionGroup;
                      CaptionML=[DEU=Allgmein;
                                 ENU=General] }
      { 1140013 ;2   ;Action    ;
                      Name=Ausfuehren;
                      CaptionML=DEU=Ausfhren;
                      Promoted=Yes;
                      PromotedIsBig=Yes;
                      Image=ExecuteBatch;
                      PromotedCategory=Process;
                      OnAction=BEGIN
                                 //Prft, ob mehrere Jobs gleichzeitig gestartet werden und verhindert dies ggf.
                                 selected := 0;
                                 IF ((Žnd_Best_PDF) OR (Žnd_Best_Druck) OR (AU_Best_PDF) OR (AU_Best_Druck)) THEN selected += 1;
                                 IF (Rechnung_PDF) THEN selected += 1;
                                 IF (Rahmenauftrag_PDF) THEN selected += 1;
                                 IF (Bestellung_PDF) THEN selected += 1;
                                 IF (Servicevertr„ge_PDF) THEN selected += 1;
                                 IF (Certificates_PDF) THEN selected += 1;

                                 IF selected > 1 THEN ERROR(Text000);

                                 Run_Batch;
                               END;
                                }
      { 1000000015;1 ;ActionGroup;
                      CaptionML=DEU=Funktionen }
      { 1000000016;2 ;Action    ;
                      Name=Docuware_Disable;
                      CaptionML=DEU=Docuware deaktivieren;
                      Image=Stop;
                      OnAction=BEGIN
                                 DocuwareServiceEnable := FALSE;
                               END;
                                }
    }
  }
  CONTROLS
  {
    { 1900000;0;Container ;
                ContainerType=ContentArea }

    { 1000000004;1;Group  ;
                CaptionML=DEU=Hinweis;
                GroupType=Group }

    { 1000000003;2;Field  ;
                CaptionML=DEU=Bitte immer den Ausfhren Button benutzen!;
                Style=Unfavorable;
                StyleExpr=TRUE }

    { 1000000002;1;Group  ;
                CaptionML=DEU=Eingabe;
                GroupType=Group }

    { 1000000007;2;Group  ;
                GroupType=Group }

    { 1140000;3;Field     ;
                CaptionML=DEU=Datum;
                SourceExpr=Tagesdatum }

    { 1000000006;3;Field  ;
                CaptionML=DEU=Optional;
                Style=Strong;
                StyleExpr=TRUE }

    { 1000000005;3;Field  ;
                CaptionML=DEU=Belegnr.;
                SourceExpr=belegnr }

    { 1000000000;1;Group  ;
                CaptionML=DEU=Auftragsbest„tigungen;
                GroupType=Group }

    { 1900001;2;Group     ;
                GroupType=Group }

    { 1000000008;3;Field  ;
                CaptionML=DEU=Info: Filter Belegnr. m”glich;
                Style=StrongAccent;
                StyleExpr=TRUE }

    { 1140002;3;Field     ;
                CaptionML=DEU=Auftragsbest„tigungen drucken;
                SourceExpr=AU_Best_Druck }

    { 1140003;3;Field     ;
                CaptionML=DEU=Auftragsbest„tigungen als PDF erstellen;
                SourceExpr=AU_Best_PDF }

    { 1140004;3;Field     ;
                CaptionML=DEU=Žnderungsauftragsbest„tigungen drucken;
                SourceExpr=Žnd_Best_Druck }

    { 1140005;3;Field     ;
                CaptionML=DEU=Žnderungsauftragsbest„tigung als PDF erstellen;
                SourceExpr=Žnd_Best_PDF }

    { 1140011;3;Field     ;
                CaptionML=DEU=interne AB-Kopie nicht drucken;
                SourceExpr=interne_AB_nicht_drucken }

    { 1000000001;1;Group  ;
                CaptionML=DEU=Sonstiges;
                GroupType=Group }

    { 1000000010;2;Group  ;
                GroupType=Group }

    { 1000000009;3;Field  ;
                CaptionML=DEU=Info: Filter Belegnr. m”glich;
                Style=StrongAccent;
                StyleExpr=TRUE }

    { 1140014;3;Field     ;
                CaptionML=DEU=Rechnungen als PDF;
                SourceExpr=Rechnung_PDF }

    { 1000000012;3;Field  ;
                CaptionML=DEU=Rahmenauftr„ge als PDF;
                SourceExpr=Rahmenauftrag_PDF }

    { 1140018;3;Field     ;
                CaptionML=DEU=Bestellungen als PDF;
                SourceExpr=Bestellung_PDF }

    { 1000000011;3;Field  ;
                CaptionML=DEU=Zur Zeit kein Filter Belegnr. m”glich!;
                Style=Unfavorable;
                StyleExpr=TRUE }

    { 1140020;3;Field     ;
                CaptionML=DEU=Servicevertr„gen als PDF;
                SourceExpr=Servicevertr„ge_PDF }

    { 1000000013;3;Field  ;
                CaptionML=DEU=ACTS Certificates als PDF;
                SourceExpr=Certificates_PDF }

  }
  CODE
  {
    VAR
      "Printer selection"@1140015 : Record 78;
      Customer@1140005 : Record 18;
      sales_header@1140008 : Record 36;
      sales_line@1140007 : Record 37;
      rahmen@1140006 : Record 36;
      sales_arch_header@1140023 : Record 5107;
      inv_header@1140003 : Record 112;
      purch_header@1140028 : Record 38;
      ship_header@1000000008 : Record 110;
      ship_line@1000000022 : Record 111;
      Wartungsvertrag@1000000007 : Record 50011;
      Servicepositionen@1000000006 : Record 50024;
      Vendor@1000000027 : Record 23;
      FileServer@1000000021 : Record 2000000022;
      Tagesdatum@1140014 : Date;
      Žnd_Best_PDF@1140013 : Boolean;
      Žnd_Best_Druck@1140012 : Boolean;
      AU_Best_PDF@1140011 : Boolean;
      AU_Best_Druck@1140010 : Boolean;
      interne_AB_nicht_drucken@1140009 : Boolean;
      Rechnung_PDF@1140000 : Boolean;
      Rahmenauftrag_PDF@1000000010 : Boolean;
      Bestellung_PDF@1140024 : Boolean;
      Servicevertr„ge_PDF@1140025 : Boolean;
      Certificates_PDF@1000000011 : Boolean;
      TOPAS_API@1140002 : Codeunit 50001;
      Bullzip_PDF@1140016 : Codeunit 50005;
      DocuWare@1000000029 : Codeunit 50016;
      WshShell@1000000017 : Automation "{F935DC20-1CF0-11D0-ADB9-00C04FD58A0B} 1.0:{72C24DD5-D70A-438B-8A42-98424B88AFB8}:'Windows Script Host Object Model'.WshShell";
      AttachmentPath@1140001 : Text;
      belege@1140017 : Text;
      belegnr@1140004 : Code[20];
      LagerortcodeFilter@1000000009 : Code[40];
      body@1140021 : Text;
      subject@1140020 : Text;
      chr@1140019 : Char;
      email_addr@1140018 : Text;
      Text000@1140026 : TextConst 'DEU=Sie k”nnen nicht mehrere Jobs gleichzeitig laufen lassen!';
      selected@1140027 : Integer;
      wartungsnr_save@1000000005 : ARRAY [5] OF Text;
      vertrag_gedruckt@1000000004 : Boolean;
      au_wartungsnr@1000000003 : ARRAY [5] OF Text;
      i@1000000002 : Integer;
      k@1000000001 : Integer;
      t@1000000000 : Integer;
      Subject_Text@1000000015 : TextConst 'DEU=Support Service Certificate fr %1  - Ihre Bestellung %2;ENU=Support Service Certificate for %1  - Your Order %2';
      Body_Text@1000000014 : TextConst 'DEU=Sehr geehrte Damen und Herren%1%1anbei finden Sie den ACTS-Servicevertrag zu Ihrer o.g. Bestellung. Bitte senden Sie diesen an Ihren Endkunden weiter.%1%1Bei weiteren Fragen stehen wir Ihnen gerne zur Verfgung.%1%1Mit freundlichen Gráen,%1%1;ENU=Dear Ladies and Gentlemen,%1%1attached you will find the ACTS service contract for your order mentioned above. Please send it to your End Customer.%1%1For further questions please do not hesitate to contact us.%1%1With kind regards,%1%1';
      Result_Text@1000000013 : TextConst 'DEU=Es wurde(n) insgesamt %1 Support Certificate(s) abgearbeitet. Bitte prfen Sie, ob genauso viele E-Mails erstellt wurden.\\Aktueller Hinweis: Bitte schneiden Sie die Service E-Mail Adresse aus dem Text aus und fgen sie es in das E-Mail Feld ein. Es gibt aktuell Probleme mit der GroupWise 18 Version.';
      Proxy_Error@1000000012 : TextConst 'DEU=Bitte nehmen Sie das Konto %1 in Ihre GroupWise Vertretung auf, damit das Programm richtig ausgefhrt werden kann.';
      attach_files@1000000016 : Text;
      Program_SearchAndForward@1000000020 : Text;
      Account@1000000019 : Text;
      Acc_Password@1000000031 : Text;
      cached_processes@1000000018 : Text;
      Service_Infotext_deu@1000000023 : TextConst 'DEU=Nach erfolgreicher Anmeldung unter https://www.topas-systems.de/mytopas k”nnen Sie unsere Service Vertragsbedingungen einsehen.';
      Service_Infotext_enu@1000000024 : TextConst 'DEU=After successful registration under https://www.topas-systems.de/mytopas you can see our service contract conditions.';
      CHAMPS_Agreement_deu@1000000025 : TextConst 'DEU=Zus„tzlich erhalten Sie eine AV CHAMPS Vereinbarung. Bitte schicken Sie diese unterschrieben an uns zurck oder bersenden uns Ihren hauseigenen AV-Vertrag zur Zeichnung.';
      CHAMPS_Agreement_enu@1000000026 : TextConst 'DEU=Additionally, you will receive an AV CHAMPS agreement. Please send this signed back to us or you send us your in-house agreement.';
      shipments@1000000028 : Integer;
      DocuwareServiceEnable@1000000030 : Boolean;

    PROCEDURE Run_Batch@1140010();
    BEGIN
      belege := '';
      IF belegnr <> '' THEN
        DocuwareServiceEnable := FALSE
      ELSE
        DocuwareServiceEnable := TRUE;

      //Auftragsbest„tigungen
      IF AU_Best_Druck THEN BEGIN
        sales_header.RESET;
        sales_header.SETFILTER("Document Type",'%1',sales_header."Document Type"::Order);
        sales_header.SETFILTER("Sell-to Customer No.",'<>%1','');
        sales_header.SETFILTER("Order Date",'%1',Tagesdatum);
        sales_header.SETFILTER("Location Code",LagerortcodeFilter);
        sales_header.SETFILTER("AB via EMail",'%1',FALSE);
        sales_header.SETFILTER("No.",belegnr);
        IF sales_header.FINDFIRST THEN BEGIN
          //  Druckt auf Papier nur mit Logo rechts oben
          REPORT.RUNMODAL(50075,FALSE,FALSE,sales_header);
        END;
      END;


      //AB-Žnderungsbest„tigungen
      IF Žnd_Best_Druck THEN BEGIN
        sales_header.RESET;
        sales_header.SETFILTER("Document Type",'%1',sales_header."Document Type"::Order);
        sales_header.SETFILTER("Sell-to Customer No.",'<>%1','');
        sales_header.SETFILTER("Document Date",'%1',Tagesdatum);
        sales_header.SETFILTER("Posting Date",'<>%1',Tagesdatum);
        sales_header.SETFILTER("Location Code",LagerortcodeFilter);
        sales_header.SETFILTER("AB via EMail",'%1',FALSE);
        sales_header.SETFILTER("No.",belegnr);
        IF sales_header.FINDFIRST THEN BEGIN
          // Druckt auf Papier nur mit Logo rechts oben
          REPORT.RUNMODAL(50098,FALSE,FALSE,sales_header);
         END;
      END;


      //Auftragsbest„tigungen per PDF
      IF AU_Best_PDF THEN BEGIN
        // Druckt Seite 2 auf Papier
        IF interne_AB_nicht_drucken = FALSE THEN BEGIN
          sales_header.RESET;
          sales_header.SETFILTER("Document Type",'%1',sales_header."Document Type"::Order);
          sales_header.SETFILTER("Sell-to Customer No.",'<>%1','');
          sales_header.SETFILTER("Order Date",'%1',Tagesdatum);
          sales_header.SETFILTER("Location Code",LagerortcodeFilter);
          sales_header.SETFILTER("AB via EMail",'%1',TRUE);
          sales_header.SETFILTER("No.",belegnr);
          IF sales_header.FINDFIRST THEN BEGIN
            REPORT.RUNMODAL(50075,FALSE,FALSE,sales_header);
          END;
        END;

        // Druck als PDF
        sales_header.RESET;
        sales_header.SETFILTER("Document Type",'%1',sales_header."Document Type"::Order);
        sales_header.SETFILTER("Sell-to Customer No.",'<>%1','');
        sales_header.SETFILTER("Order Date",'%1',Tagesdatum);
        sales_header.SETFILTER("Location Code",LagerortcodeFilter);
        sales_header.SETFILTER("AB via EMail",'%1',TRUE);
        sales_header.SETFILTER("No.",belegnr);
        IF sales_header.FINDFIRST THEN BEGIN

          Bullzip_PDF.BullzipPDF_Order(sales_header,AttachmentPath,50075);

          //14.11.14 ST - Rahmenauftrag hinzu, wenn im Rahmen kein Haken im Feld "keine Rahmen-AB via Email" gesetzt ist
          sales_header.FINDFIRST;
          REPEAT
            sales_line.RESET;
            sales_line.SETFILTER(Type,'%1',sales_line.Type::Item);
            sales_line.SETFILTER("Document No.",'%1',sales_header."No.");
            sales_line.SETFILTER("Blanket Order No.",'<>%1','');
            IF sales_line.FINDFIRST THEN
              REPEAT
                rahmen.RESET;
                rahmen.SETFILTER("No.",'%1',sales_line."Blanket Order No.");
                rahmen.SETFILTER("Virtuelle Systeme",'%1',FALSE);
                IF (rahmen.FINDFIRST) AND (rahmen."Document Date" = sales_header."Document Date")
                AND (rahmen."keine Rahmen-AB via Email" = FALSE) THEN
                  IF STRPOS(belege,rahmen."No." + '.pdf') = 0 THEN BEGIN
                    belege := belege + ',' + rahmen."No." + '.pdf';
                    Bullzip_PDF.BullzipPDF_Order(rahmen,AttachmentPath,50115);
                  END;
              UNTIL sales_line.NEXT = 0;
          UNTIL sales_header.NEXT = 0;

        END;

        //Alle Auftragsbest„tigungen als PDF an DocuWare Scan Ordner senden
        IF DocuwareServiceEnable THEN DocuWare.ExportDocsToFolder(2,Tagesdatum);
      END;


      //Auftrag„nderungsbest„tigungen per PDF
      IF Žnd_Best_PDF THEN BEGIN
        // Druckt Seite 2 auf Papier
        IF interne_AB_nicht_drucken = FALSE THEN BEGIN
          sales_header.RESET;
          sales_header.SETFILTER("Document Type",'%1',sales_header."Document Type"::Order);
          sales_header.SETFILTER("Sell-to Customer No.",'<>%1','');
          sales_header.SETFILTER("Document Date",'%1',Tagesdatum);
          sales_header.SETFILTER("Posting Date",'<>%1',Tagesdatum);
          sales_header.SETFILTER("Location Code",LagerortcodeFilter);
          sales_header.SETFILTER("AB via EMail",'%1',TRUE);
          sales_header.SETFILTER("No.",belegnr);
          IF sales_header.FINDFIRST THEN BEGIN
            REPORT.RUNMODAL(50098,FALSE,FALSE,sales_header);
          END;
        END;

        // Druck als PDF
        sales_header.RESET;
        sales_header.SETFILTER("Document Type",'%1',sales_header."Document Type"::Order);
        sales_header.SETFILTER("Sell-to Customer No.",'<>%1','');
        sales_header.SETFILTER("Document Date",'%1',Tagesdatum);
        sales_header.SETFILTER("Posting Date",'<>%1',Tagesdatum);
        sales_header.SETFILTER("Location Code",LagerortcodeFilter);
        sales_header.SETFILTER("AB via EMail",'%1',TRUE);
        sales_header.SETFILTER("No.",belegnr);
        IF sales_header.FINDFIRST THEN BEGIN

          Bullzip_PDF.BullzipPDF_Order(sales_header,AttachmentPath,50098);

          //14.11.14 ST - Rahmenauftrag hinzu, wenn im Rahmen kein Haken im Feld "keine Rahmen-AB via Email" gesetzt ist
          sales_header.FINDFIRST;
          REPEAT
            sales_line.RESET;
            sales_line.SETFILTER(Type,'%1',sales_line.Type::Item);
            sales_line.SETFILTER("Document No.",'%1',sales_header."No.");
            sales_line.SETFILTER("Blanket Order No.",'<>%1','');
            IF sales_line.FINDFIRST THEN
              REPEAT
                rahmen.RESET;
                rahmen.SETFILTER("No.",'%1',sales_line."Blanket Order No.");
                rahmen.SETFILTER("Virtuelle Systeme",'%1',FALSE);
                IF (rahmen.FINDFIRST) AND (rahmen."Document Date" = sales_header."Document Date")
                AND (rahmen."keine Rahmen-AB via Email" = FALSE) THEN
                  IF STRPOS(belege,rahmen."No." + '.pdf') = 0 THEN BEGIN
                    belege := belege + ',' + rahmen."No." + '.pdf';
                    Bullzip_PDF.BullzipPDF_Order(rahmen,AttachmentPath,50115);
                  END;
              UNTIL sales_line.NEXT = 0;
          UNTIL sales_header.NEXT = 0;

        END;

        //Alle Auftrags„nderungsbest„tigungen als PDF an DocuWare Scan Ordner senden
        IF DocuwareServiceEnable THEN DocuWare.ExportDocsToFolder(3,Tagesdatum);
      END;



      // Rechnungen per PDF
      IF Rechnung_PDF THEN BEGIN
        inv_header.RESET;
        inv_header.SETFILTER("Posting Date",'%1',Tagesdatum);
        inv_header.SETFILTER("Location Code",'<>%1','MUST');
        inv_header.SETFILTER("No.",belegnr);
        IF inv_header.FINDFIRST THEN BEGIN
          Bullzip_PDF.BullzipPDF_Invoice(inv_header,AttachmentPath,50076);
          //Fr Ger„te von ACS und FER werden die Lieferscheine erzeugt und zus„tzlich angehangen
          inv_header.FINDFIRST;
          REPEAT
            ship_header.RESET;
            ship_header.SETRANGE("Order No.",inv_header."Order No.");
            ship_header.SETRANGE("Posting Date",inv_header."Posting Date");
            IF ship_header.FINDFIRST THEN BEGIN
              REPEAT
                ship_line.RESET;
                ship_line.SETRANGE("Document No.",ship_header."No.");
                ship_line.SETFILTER("Manufacturer Code",'59|85');
                ship_line.SETFILTER(Quantity,'>%1',0);
                IF ship_line.FINDFIRST THEN
                  Bullzip_PDF.BullzipPDF_Shipment(ship_header,AttachmentPath,50078);
              UNTIL ship_header.NEXT = 0;
            END;
          UNTIL inv_header.NEXT = 0;
        END;
      END;


      // Rahmenauftrag per PDF
      IF Rahmenauftrag_PDF THEN BEGIN
        rahmen.RESET;
        rahmen.SETFILTER("Document Type",'%1',rahmen."Document Type"::"Blanket Order");
        rahmen.SETFILTER("Posting Date",'%1',Tagesdatum);
        rahmen.SETFILTER("Location Code",'<>%1','MUST');
        rahmen.SETFILTER("No.",belegnr);
        IF rahmen.FINDFIRST THEN BEGIN
          Bullzip_PDF.BullzipPDF_Order(rahmen,AttachmentPath,50115);
        END;
      END;


      //Bestellungen per PDF
      IF Bestellung_PDF THEN BEGIN
        purch_header.RESET;
        purch_header.SETFILTER("Document Type",'%1',purch_header."Document Type"::Order);
        purch_header.SETFILTER("Location Code",'<>%1','MUST');
        purch_header.SETFILTER("Buy-from Vendor No.",'<>%1&<>%2&<>%3&<>%4','600055','880045','880072','610008');
        purch_header.SETFILTER("Order Date",'%1',Tagesdatum);
        purch_header.SETFILTER("No.",belegnr);
        //purch_header.SETFILTER("AB via EMail",'%1',TRUE);
        IF purch_header.FINDFIRST THEN BEGIN
          Bullzip_PDF.BullzipPDF_PurchaseOrder(purch_header,AttachmentPath,50019);
        END;
      END;


      //Servicevertr„ge per PDF
      IF Servicevertr„ge_PDF THEN BEGIN
        ship_header.RESET;
        ship_header.SETFILTER("Posting Date",'%1',Tagesdatum);
        IF ship_header.FINDFIRST THEN
          Bullzip_PDF.BullzipPDF_ServiceContract(ship_header,AttachmentPath,50178);
      END;




      //COMMIT;

      chr := 10;

      //*******************************************************************************************************
      // Mail Job fr Auftragsbest„tigungen
      //*******************************************************************************************************

      IF AU_Best_PDF THEN BEGIN
        sales_header.RESET;
        sales_header.SETFILTER("Document Type",'%1',sales_header."Document Type"::Order);
        sales_header.SETFILTER("Sell-to Customer No.",'<>%1','');
        sales_header.SETFILTER("Order Date",'%1',Tagesdatum);
        sales_header.SETFILTER("Location Code",LagerortcodeFilter);
        IF belegnr = '' THEN
          sales_header.SETFILTER("AB via EMail",'%1',TRUE)
        ELSE
          sales_header.SETFILTER("No.",belegnr);
        IF sales_header.FINDFIRST THEN BEGIN
          //IF CONFIRM('Auftragsbest„tigung: Wurden alle PDFs vollst„ndig abgelegt?',TRUE) THEN BEGIN
            chr := 10;
            REPEAT
              IF sales_header."Language Code" <> 'ENU' THEN BEGIN
                body := 'Sehr geehrte Damen und Herren,' + FORMAT(chr) + FORMAT(chr) +
                        'vielen Dank fr Ihre Bestellung. Anbei finden Sie Ihre Auftragsbest„tigung.';
                subject := 'Auftragsbest„tigung: ';
              END ELSE BEGIN
                body := 'Dear Sir or Madam,' + FORMAT(chr) + FORMAT(chr) +
                        'thank you for your order. Attached you will find your order confirmation.';
                subject := 'Order confirmation: ';
              END;

              belege := sales_header."No." + '.pdf';

              //14.11.14 ST - Rahmenauftrag hinzu, wenn im Rahmen kein Haken im Feld "keine Rahmen-AB via Email" gesetzt ist
              sales_line.RESET;
              sales_line.SETFILTER(Type,'%1',sales_line.Type::Item);
              sales_line.SETFILTER("Document No.",'%1',sales_header."No.");
              sales_line.SETFILTER("Blanket Order No.",'<>%1','');
              IF sales_line.FINDFIRST THEN
                REPEAT
                  rahmen.RESET;
                  rahmen.SETFILTER("No.",'%1',sales_line."Blanket Order No.");
                  rahmen.SETFILTER("Virtuelle Systeme",'%1',FALSE);
                  IF (rahmen.FINDFIRST) AND (rahmen."Document Date" = sales_header."Document Date")
                  AND (rahmen."keine Rahmen-AB via Email" = FALSE) THEN
                    IF STRPOS(belege,rahmen."No." + '.pdf') = 0 THEN
                      belege := belege + ',' + rahmen."No." + '.pdf';
                UNTIL sales_line.NEXT = 0;

              IF CheckCHAMPS_AV_notwendig(sales_header) THEN
                IF sales_header."Language Code" <> 'ENU' THEN BEGIN
                  belege := belege + ',F:\Daten NEU\Gemeinsame Ordner\Compliance\Datenschutz\AV_Vorlagen_TOPAS\AV_Champs_TOPAS.pdf';
                  body := body + FORMAT(chr) + CHAMPS_Agreement_deu;
                END ELSE BEGIN
                  belege := belege + ',F:\Daten NEU\Gemeinsame Ordner\Compliance\Datenschutz\AV_Vorlagen_TOPAS\AV_Champs_TOPAS_engl.pdf';
                  body := body + FORMAT(chr) + CHAMPS_Agreement_enu;
                END;

              TOPAS_API.NewMail(sales_header."AB EMail-Adresse",'','',subject+
              sales_header."External Document No.",body,AttachmentPath,belege);
            UNTIL sales_header.NEXT = 0;
          //END;
        END;
      END;


      // Mail Job fr AB-Žnderungsbest„tigungen
      IF Žnd_Best_PDF THEN BEGIN
        sales_header.RESET;
        sales_header.SETFILTER("Document Type",'%1',sales_header."Document Type"::Order);
        sales_header.SETFILTER("Sell-to Customer No.",'<>%1','');
        sales_header.SETFILTER("Document Date",'%1',Tagesdatum);
        sales_header.SETFILTER("Posting Date",'<>%1',Tagesdatum);
        sales_header.SETFILTER("Location Code",LagerortcodeFilter);
        IF belegnr = '' THEN
          sales_header.SETFILTER("AB via EMail",'%1',TRUE)
        ELSE
          sales_header.SETFILTER("No.",belegnr);
        IF sales_header.FINDFIRST THEN BEGIN
          //IF CONFIRM('Žnderungs-ABs: Wurden alle PDFs vollst„ndig abgelegt?',TRUE) THEN BEGIN
            chr := 10;
            REPEAT
              IF sales_header."Language Code" <> 'ENU' THEN BEGIN
                body := 'Sehr geehrte Damen und Herren,' + FORMAT(chr) + FORMAT(chr) +
                        'anbei erhalten Sie die ge„nderte Auftragsbest„tigung.';
                subject := 'Žnderungs-Auftragsbest„tigung: ';
              END ELSE BEGIN
                body := 'Dear Sir or Madam,' + FORMAT(chr) + FORMAT(chr) +
                        'attached you will find a change order confirmation.';
                subject := 'Change order confirmation: ';
              END;

              belege := sales_header."No." + '.pdf';

              //14.11.14 ST - Rahmenauftrag hinzu, wenn im Rahmen kein Haken im Feld "keine Rahmen-AB via Email" gesetzt ist
              sales_line.RESET;
              sales_line.SETFILTER(Type,'%1',sales_line.Type::Item);
              sales_line.SETFILTER("Document No.",'%1',sales_header."No.");
              sales_line.SETFILTER("Blanket Order No.",'<>%1','');
              IF sales_line.FINDFIRST THEN
                REPEAT
                  rahmen.RESET;
                  rahmen.SETFILTER("No.",'%1',sales_line."Blanket Order No.");
                  rahmen.SETFILTER("Virtuelle Systeme",'%1',FALSE);
                  IF (rahmen.FINDFIRST) AND (rahmen."Document Date" = sales_header."Document Date")
                  AND (rahmen."keine Rahmen-AB via Email" = FALSE) THEN
                    IF STRPOS(belege,rahmen."No." + '.pdf') = 0 THEN
                      belege := belege + ',' + rahmen."No." + '.pdf';
                UNTIL sales_line.NEXT = 0;

              IF CheckCHAMPS_AV_notwendig(sales_header) THEN
                IF sales_header."Language Code" <> 'ENU' THEN BEGIN
                  belege := belege + ',F:\Daten NEU\Gemeinsame Ordner\Compliance\Datenschutz\AV_Vorlagen_TOPAS\AV_Champs_TOPAS.pdf';
                  body := body + FORMAT(chr) + 'Zus„tzlich erhalten Sie eine AV CHAMPS Vereinbarung. Bitte schicken Sie diese unterschrieben an uns zurck.';
                END ELSE BEGIN
                  belege := belege + ',F:\Daten NEU\Gemeinsame Ordner\Compliance\Datenschutz\AV_Vorlagen_TOPAS\AV_Champs_TOPAS_engl.pdf';
                  body := body + FORMAT(chr) + 'Additionally, you will receive an AV CHAMPS agreement. Please send this signed back to us.'
                END;

              TOPAS_API.NewMail(sales_header."AB EMail-Adresse",'','',subject+
              sales_header."External Document No.",body,AttachmentPath,belege);
            UNTIL sales_header.NEXT = 0;
          //END;
        END;
      END;


      // Mail-Job fr Rechnungen
      IF Rechnung_PDF THEN BEGIN
        inv_header.RESET;
        inv_header.SETFILTER("Posting Date",'%1',Tagesdatum);
        inv_header.SETFILTER("Location Code",'<>%1','MUST');
        inv_header.SETFILTER("No.",belegnr);
        IF inv_header.FINDFIRST THEN BEGIN
          REPEAT
            subject := '';
            body := '';
            email_addr := '';
            attach_files := '';
            shipments := 0;
            Customer.GET(inv_header."Bill-to Customer No.");
            IF (Customer."Rech via EMail" = TRUE) OR (belegnr <> '') THEN BEGIN
              IF inv_header."Language Code" <> 'ENU' THEN BEGIN
                body := 'Sehr geehrte Damen und Herren,' + FORMAT(chr) + FORMAT(chr) +
                        'anbei erhalten Sie Ihre Rechnung.' + FORMAT(chr);
                subject := 'Rechnung zu Ihrer Bestellung: ' + inv_header."External Document No.";
              END ELSE BEGIN
                body := 'Dear Sir or Madam,' + FORMAT(chr) + FORMAT(chr) +
                        'attached you will find your invoice.' + FORMAT(chr);
                subject := 'Invoice for your order: ' + inv_header."External Document No.";
              END;

              attach_files := inv_header."No." + '.pdf';

              ship_header.RESET;
              ship_header.SETFILTER("Order No.",'%1',inv_header."Order No.");
              ship_header.SETFILTER("Posting Date",'%1',inv_header."Posting Date");
              IF ship_header.FINDFIRST THEN BEGIN
                REPEAT
                  ship_line.RESET;
                  ship_line.SETRANGE("Document No.",ship_header."No.");
                  ship_line.SETFILTER("Manufacturer Code",'59|85');
                  ship_line.SETFILTER(Quantity,'>%1',0);
                  IF ship_line.FINDFIRST THEN BEGIN
                    attach_files := attach_files + ',' + AttachmentPath + ship_header."No." + '.pdf';
                    shipments += 1;
                  END;
                UNTIL ship_header.NEXT = 0;
                IF inv_header."Language Code" <> 'ENU' THEN BEGIN
                  body := 'Sehr geehrte Damen und Herren,' + FORMAT(chr) + FORMAT(chr) +
                          'anbei erhalten Sie Ihre Rechnung%1.' + FORMAT(chr);
                  IF shipments > 1 THEN
                    body := STRSUBSTNO(body,' und Ihre Lieferscheine')
                  ELSE
                    IF shipments = 1 THEN
                      body := STRSUBSTNO(body,' und Ihren Lieferschein')
                    ELSE
                      body := STRSUBSTNO(body,'');
                END ELSE BEGIN
                  body := 'Dear Sir or Madam,' + FORMAT(chr) + FORMAT(chr) +
                          'attached you will find your invoice%1.' + FORMAT(chr);
                  IF shipments > 1 THEN
                    body := STRSUBSTNO(body,' and your delivery notes')
                  ELSE
                    IF shipments = 1 THEN
                      body := STRSUBSTNO(body,' and your delivery note')
                    ELSE
                      body := STRSUBSTNO(body,'');
                END;
                IF inv_header."Language Code" <> 'ENU' THEN
                  body += 'Das Paket wurde mit ' + ship_header."Shipping Agent Code" + ': ' + ship_header."Package Tracking No." + ' verschickt.'
                ELSE
                  body += 'The packet was sent via ' + ship_header."Shipping Agent Code" + ': ' + ship_header."Package Tracking No.";
              END;

              //Email-Adresse wird ausfindig gemacht, wird keine gefunden, wird dennoch eine E-Mail generiert
              sales_header.RESET;
              sales_header.SETFILTER("No.",'%1',inv_header."Order No.");
              IF sales_header.FINDFIRST THEN
                email_addr := sales_header."Rech EMail-Adresse";
              IF email_addr = '' THEN BEGIN
                sales_arch_header.RESET;
                sales_arch_header.SETFILTER("No.",'%1',inv_header."Order No.");
                IF sales_arch_header.FINDFIRST THEN
                  email_addr := sales_arch_header."Rech EMail-Adresse";
                IF email_addr = '' THEN
                  email_addr := Customer."Rech EMail-Adresse";
              END;

              TOPAS_API.NewMail(email_addr,'','',subject,body,AttachmentPath,attach_files);
            END;
          UNTIL inv_header.NEXT = 0;
        END;
      END;


      // Mail-Job fr Rahmenauftrag
      IF Rahmenauftrag_PDF THEN BEGIN
        rahmen.RESET;
        rahmen.SETFILTER("Document Type",'%1',rahmen."Document Type"::"Blanket Order");
        rahmen.SETFILTER("Posting Date",'%1',Tagesdatum);
        rahmen.SETFILTER("Location Code",'<>%1','MUST');
        rahmen.SETFILTER("No.",belegnr);
        IF rahmen.FINDFIRST THEN BEGIN
          REPEAT
            subject := '';
            body := '';
            email_addr := '';
            IF rahmen."Language Code" <> 'ENU' THEN BEGIN
              body := 'Sehr geehrte Damen und Herren,' + FORMAT(chr) + FORMAT(chr) +
                      'anbei erhalten Sie Ihre Kontraktbest„tigung.' + FORMAT(chr);
              subject := 'Ihre Kontraktbest„tigung: ' + rahmen."External Document No.";
            END ELSE BEGIN
              body := 'Dear Sir or Madam,' + FORMAT(chr) + FORMAT(chr) +
                      'attached you will find your contract confirmation.' + FORMAT(chr);
              subject := 'Your Contract Confirmation: ' + rahmen."External Document No.";
            END;

            email_addr := rahmen."AB EMail-Adresse";
            IF email_addr = '' THEN BEGIN
              Customer.GET(rahmen."Sell-to Customer No.");
              email_addr := Customer."Rech EMail-Adresse";
            END;

            TOPAS_API.NewMail(email_addr,'','',subject,body,AttachmentPath,rahmen."No." + '.pdf');
          UNTIL rahmen.NEXT = 0;
        END;
      END;


      // Mail-Job fr Bestellungen
      IF Bestellung_PDF THEN BEGIN
        purch_header.RESET;
        purch_header.SETFILTER("Document Type",'%1',purch_header."Document Type"::Order);
        purch_header.SETFILTER("Buy-from Vendor No.",'<>%1&<>%2&<>%3&<>%4','600055','880045','880072','610008');
        purch_header.SETFILTER("Location Code",'<>%1','MUST');
        purch_header.SETFILTER("Order Date",'%1',Tagesdatum);
        purch_header.SETFILTER("No.",belegnr);
        IF purch_header.FINDFIRST THEN BEGIN
          REPEAT
            subject := '';
            body := '';
            Vendor.GET(purch_header."Buy-from Vendor No.");
            IF purch_header."Language Code" <> 'ENU' THEN BEGIN
              body := 'Sehr geehrte Damen und Herren,' + FORMAT(chr) + FORMAT(chr) +
                      'anbei erhalten Sie unsere Bestellung.' + FORMAT(chr);
              subject := 'Bestellung: ';
            END ELSE BEGIN
              body := 'Dear Sir or Madam,' + FORMAT(chr) + FORMAT(chr) +
                      'attached you will find our purchase order.' + FORMAT(chr);
              subject := 'Purchase Order: ';
            END;
            TOPAS_API.NewMail(Vendor."E-Mail",'','',subject + purch_header."No.",body,AttachmentPath,purch_header."No." + '.pdf');
          UNTIL purch_header.NEXT = 0
        END;
      END;


      // Mail-Job fr Servicevertr„ge
      wartungsnr_save[1] := '';
      wartungsnr_save[2] := '';
      wartungsnr_save[3] := '';
      wartungsnr_save[4] := '';
      wartungsnr_save[5] := '';
      t := 1;
      IF Servicevertr„ge_PDF = TRUE THEN BEGIN
        ship_header.RESET;
        ship_header.SETFILTER("Posting Date",'%1',Tagesdatum);
        IF ship_header.FINDFIRST THEN
          REPEAT
            vertrag_gedruckt := FALSE;
            au_wartungsnr[1] := '';
            au_wartungsnr[2] := '';
            au_wartungsnr[3] := '';
            au_wartungsnr[4] := '';
            au_wartungsnr[5] := '';
            i := 1;
            Customer.GET(ship_header."Sell-to Customer No.");
            IF Customer."Service via EMail" = TRUE THEN BEGIN
              Servicepositionen.RESET;
              Servicepositionen.SETFILTER(Art,'%1',Servicepositionen.Art::Service);
              Servicepositionen.SETFILTER("Nr.",'%1',ship_header."No.");
              Servicepositionen.SETFILTER(Inaktiv,'%1',FALSE);
              IF Servicepositionen.FINDFIRST THEN BEGIN
                REPEAT
                  IF  (STRPOS(wartungsnr_save[1],Servicepositionen."Wartungsvertragsnr.") = 0)
                  AND (STRPOS(wartungsnr_save[2],Servicepositionen."Wartungsvertragsnr.") = 0)
                  AND (STRPOS(wartungsnr_save[3],Servicepositionen."Wartungsvertragsnr.") = 0)
                  AND (STRPOS(wartungsnr_save[4],Servicepositionen."Wartungsvertragsnr.") = 0)
                  AND (STRPOS(wartungsnr_save[5],Servicepositionen."Wartungsvertragsnr.") = 0) THEN
                    vertrag_gedruckt := FALSE;
                  IF vertrag_gedruckt = FALSE THEN BEGIN
                    Wartungsvertrag.RESET;
                    Wartungsvertrag.SETFILTER("Wartungsvertragsnr.",Servicepositionen."Wartungsvertragsnr.");
                    Wartungsvertrag.SETFILTER(Status,'<>%1&<>%2',Wartungsvertrag.Status::ACTS,
                                              Wartungsvertrag.Status::"Champs Partner");
                    IF Wartungsvertrag.FINDFIRST THEN BEGIN
                      vertrag_gedruckt := TRUE;
                      IF STRLEN(wartungsnr_save[t] + Servicepositionen."Wartungsvertragsnr.") > 1024 THEN
                        t += 1;
                      wartungsnr_save[t] := wartungsnr_save[t] + Servicepositionen."Wartungsvertragsnr.";

                      IF STRLEN(au_wartungsnr[i] + ',' + Wartungsvertrag."Wartungsvertragsnr."+'.pdf')  > 1024 THEN
                        i += 1;
                      IF au_wartungsnr[i] = '' THEN
                        au_wartungsnr[i] := Wartungsvertrag."Wartungsvertragsnr."+'.pdf'
                      ELSE
                        au_wartungsnr[i] := au_wartungsnr[i] + ',' + Wartungsvertrag."Wartungsvertragsnr."+'.pdf';
                    END;
                  END;
                UNTIL Servicepositionen.NEXT = 0;

                FOR k := 1 TO i DO BEGIN
                  IF au_wartungsnr[k] <> '' THEN BEGIN
                    subject := '';
                    body := '';
                    IF ship_header."Language Code" <> 'ENU' THEN BEGIN
                      IF STRPOS(au_wartungsnr[k],',') = 0 THEN
                        body := 'Sehr geehrte Damen und Herren,' + FORMAT(chr) + FORMAT(chr) +
                              'anbei erhalten Sie Ihren Servicevertrag.' + FORMAT(chr) +
                              Service_Infotext_deu + FORMAT(chr)
                      ELSE
                        body := 'Sehr geehrte Damen und Herren,' + FORMAT(chr) + FORMAT(chr) +
                              'anbei erhalten Sie Ihre Servicevertr„ge.' + FORMAT(chr) +
                              Service_Infotext_deu + FORMAT(chr);
                      subject := 'Ihre Referenz: ';
                    END ELSE BEGIN
                      IF STRPOS(au_wartungsnr[k],',') = 0 THEN
                        body := 'Dear Sir or Madam,' + FORMAT(chr) + FORMAT(chr) +
                                'attached you will find your service contract.' + FORMAT(chr) +
                                Service_Infotext_enu + FORMAT(chr)
                      ELSE
                        body := 'Dear Sir or Madam,' + FORMAT(chr) + FORMAT(chr) +
                                'attached you will find your service contracts.' + FORMAT(chr) +
                                Service_Infotext_enu + FORMAT(chr);
                      subject := 'Your reference: ';
                    END;
                    TOPAS_API.NewMail(ship_header."Service EMail-Adresse",'','',subject+
                    ship_header."External Document No.",body,AttachmentPath,au_wartungsnr[k]);
                  END;
                END;
              END;
            END;
          UNTIL ship_header.NEXT = 0;
      END;


      //Mail-Job fr Support Services Certificates von AudioCodes
      IF Certificates_PDF THEN BEGIN
        CREATE(WshShell,FALSE,TRUE);
        //Program_SearchAndForward := 'D:\GWMailForwardWithAttachment.exe';
        Program_SearchAndForward := '"\\WIN-FILESRV\Software\software\TOPAS eigen\GWMailForward\GWMailForwardWithAttachment.exe"';
        AttachmentPath := '\\WIN-FILESRV\Daten\Daten NEU\Gemeinsame Ordner\Customer Service\AudioCodes\';
        Account := 'Systeme';
        IF TOPAS_API.ChangeProxy(Account) <> '' THEN ERROR(Proxy_Error,Account);

        CLEAR(ship_header);
        cached_processes := '';
        Servicepositionen.RESET;
        Servicepositionen.SETRANGE(Art,Servicepositionen.Art::Service);
        Servicepositionen.SETRANGE("Zu Versenden",TRUE);
        IF Servicepositionen.FINDSET THEN BEGIN
          REPEAT
            IF STRPOS(cached_processes,Servicepositionen."ACO Nr.") = 0 THEN BEGIN
              attach_files := '';
              ship_header.SETFILTER("No.",Servicepositionen."Nr.");
              IF ship_header.FINDFIRST THEN BEGIN
                Bullzip_PDF.BullzipPDF_Shipment(ship_header,AttachmentPath + '_Lieferscheine',50078);
                attach_files += AttachmentPath + '_Lieferscheine\' + ship_header."No." + '.pdf';
                SLEEP(500);
                //CurrPage.LANGUAGE := Language.GetLanguageID(Ship_Header."Language Code");
              END;

              FileServer.ASCENDING(FALSE);
              FileServer.SETFILTER(Path, AttachmentPath + Servicepositionen."Wartungsvertragsnr.");
              FileServer.SETFILTER(Name,Servicepositionen."ACO Nr." + '*.pdf');
              FileServer.SETRANGE("Is a file", TRUE);
              IF FileServer.FINDSET THEN BEGIN
                attach_files += ',' + AttachmentPath + Servicepositionen."Wartungsvertragsnr." + '\' + FileServer.Name;
                //wird erstmal nicht ben”tigt, ist aber ein guter Weg, um die Problematik der Tabelle File mit max. Dateinamen L„nge 100 Zeichen zu umgehen
                {
                FileMgt.GetClientDirectoryFilesList(NameValueBuffer,AttachmentPath + Servicepositionen."Wartungsvertragsnr.");
                NameValueBuffer.RESET;
                NameValueBuffer.SETFILTER(Name,'*' + Servicepositionen."ACO Nr." + '*.htm');
                IF NameValueBuffer.FINDSET THEN BEGIN
                END;
                }
              END ELSE BEGIN
                FileServer.SETFILTER(Path, AttachmentPath + Servicepositionen."BET-Nr.");
                IF FileServer.FINDSET THEN BEGIN
                  attach_files += ',' + AttachmentPath + Servicepositionen."BET-Nr." + '\' + FileServer.Name;
                END
              END;

              chr := 13;
              body:= STRSUBSTNO(Body_Text,FORMAT(chr));
              subject := STRSUBSTNO(Subject_Text,Servicepositionen."System Projektinfos",ship_header."External Document No.") ;
              WshShell.Exec(Program_SearchAndForward + ' "' + Servicepositionen."ACO Nr." + '"' + ' "' + ship_header."Service EMail-Adresse" + '"' + ' "' + subject + '"' +
              ' "' + body + '"' + ' "' + attach_files + '"');
              IF STRPOS(cached_processes,Servicepositionen."ACO Nr.") = 0 THEN cached_processes += Servicepositionen."ACO Nr." + '|';
              SLEEP(500);

            END;
            Servicepositionen."Zu Versenden" := FALSE;
            Servicepositionen.MODIFY;
          UNTIL Servicepositionen.NEXT = 0;
        END;

        MESSAGE(Result_Text,STRLEN(DELCHR(cached_processes,'=',DELCHR(cached_processes,'=','|'))));
      END;
    END;

    LOCAL PROCEDURE CheckCHAMPS_AV_notwendig@1000000001(SalesHeader@1000000000 : Record 36) : Boolean;
    VAR
      Item@1000000003 : Record 27;
      SalesLine@1000000001 : Record 37;
      TroubleshootingSetup@1000000002 : Record 5945;
    BEGIN
      //06.07.2018 ST - Prfen, ob Anhang AV Vereinbarung notwendig ist, wenn noch keine ADV vorliegt und CHAMPS im Beleg gefunden wird
      SalesLine.RESET;
      SalesLine.SETRANGE("Document No.",SalesHeader."No.");
      SalesLine.SETRANGE(Type,SalesLine.Type::Item);
      IF SalesLine.FINDFIRST THEN BEGIN
        Customer.GET(SalesHeader."Sell-to Customer No.");
        REPEAT
          IF (Item.GET(SalesLine."No.") AND (Item."Software Upgrade Protection")) THEN
            TroubleshootingSetup.SETRANGE(Type,TroubleshootingSetup.Type::Item);
            TroubleshootingSetup.SETRANGE("No.",Item."No.");
            TroubleshootingSetup.SETRANGE("Troubleshooting No.",'CHAMPS');
            IF TroubleshootingSetup.FINDFIRST THEN
              IF (Customer.ADV = FALSE) AND (Customer."Territory Code" = 'SYSTEM') THEN BEGIN
                EXIT(TRUE)
              END;
        UNTIL SalesLine.NEXT = 0;
      END;
      EXIT(FALSE);
    END;

    BEGIN
    END.
  }
}

